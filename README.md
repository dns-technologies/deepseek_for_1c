
Здесь чисто техническое описание. Зачем это вообще нужно и что даёт, нужно смотреть на Инфостате. 

## Сборка состоит

**deepseek_postgre** - бэкап базы данных. Использовался PostgreSQL 17. Заведён пользователь postgres, пароль 1234. Состоит из трёх таблиц

history - записывает обращения пользователи, так же ответы ИИ. По сути, хранит контекст общения.

messages - записывает ответ от ИИ, разбитый на порции. Также признак того, что порция уже отдвалась или нет.

system_message - некая преднастройка для ИИ. Там можно разместить как себя должна вести нейросеть, в каком стиле общаться и прочее. 

**deepseek** - папка с публикацией 1С. Работает через IIS и IISNode. IISNode позволяет размещать веб-приложения Node.js в IIS 7/8, как и приложение .NET. Инструкция для установки и работы можно почитать [здесь](https://sniffysko.blogspot.com/2018/08/iis-nodejs.html) и [здесь](https://1step2learn.com/en/article/technology/deploy-node-js-application-windows-server-iis/). Внутри лежит бандл проекта, собранный через webpack.

**deepseek_api** - папка с проектов для node js. Проект без загруженных библиотек, просто исходники, что бы посмотреть как это реализовано. Сборка делается через VS code командой "npm run build".

**1Cv8.cf** - конфигурация тестовой базы.

Самое сложное это запустить бота, потому что в 1С это всё реализовано очень криво. В теории, бот появялет в системе взаимодействия после первого вызова метода СистемаВзаимодействия.ВыполнитьОбработкуБотов(). После этого метод нужно вызывать раз в минуту. Для этого в конфигурации есть регламентное задание, НО конкретно в файловой версии даже если запускать через консоль заданий, то не факт что бот заработает. Пришлось делать отдельную внешнюю обработку, с серверной процедурой, которая по кнопке выполняет СистемаВзаимодействия.ВыполнитьОбработкуБотов(). Раз в минуту щёлкал эту кнопочку, но всё равно иногда система взаимодействия просто не реагировала. После перезапуска 1С исправлялось на некоторое время. В клиент-серверном варианте таеих проблем не возникало.

В самой базе 1С нужно зайти в справочник *Настройки подключения* и задать там данные для подключения к БД на Postgre, адрес публикации и данные для подключения к API ИИ.

Пример:

    Адрес сервера: sand-server/deepseek
    Адрес ИИ: https://api.deepseek.com/v1/chat/completions
    Токен ИИ: Bearer sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    Пользователь БД: postgres
    Пароль БД: 1234
    Сервер БД: sand-server
    Порт БД: 5432
    Имя БД: deepseek

**Выгрузка cf** - конфигурация, выгруженная в файлы.

## Последовательность действий

1) Установить IIS, установить URL Rewrite, установить IISNode, разместить публикацию.
2) Установить PostgreSQL 17, pgAdmin 4, запустить службу PostgreSQL. Загрузить из бэкапа базу данных.
3) При необходимости получить комьюнити лицензию. Хорошо описано [здесь](https://v8.1c.ru/podderzhka-i-obuchenie/uchebnye-versii/).
4) Скачать, установить платформу 1С. Тестировалось на 8.3.26 (файловый, клиет-сервер). Скорее всего на более ранних тоже получится. Загрузить cf файл, обновить. В режиме предприятия заполнить настройки подключения. 
5) Подключить 1С: Диалог, описано [здесь](https://rarus.ru/publications/20250429-ot-ekspertov-polnoe-rukovodstvo-po-ustanovke-1c-server-vzaimodejstviya-746988/#podklyuchenie-sistemy-vzaimodejstviya-cherez-servis-1c-dialog).
6) Запустить регламентное задание Запуск бота.
